<!DOCTYPE html>
<html>
<head>
<title>User-generated DB (PG Storage Example)</title>
<meta name="viewport" content="width=device-width, initial-scale = 1.0, user-scalable = no">
 <script type="text/javascript" charset="utf-8" src="cordova.js"></script> 
<script type="text/javascript" charset="utf-8">

function onDeviceReady() { 
 persistData(fname,lname,age,gramaNiladhariDivision,address,race,income);
}
</script>

</head>
<body>
<div class="segment">
 <h2>Storage, user-entry DB</h2>
 <input type="button" class="buttonClass" onclick='window.location="index.html"' value="Return">

 <form id="userInput" action ="" method="GET"> 
 		<div data-role="content">
		
			<div class="fname" data-role="fieldcontain">
				<label for="fname"> Home ID </label> <input name="fname"
					id="fname" placeholder="H0001" value="" data-mini="true" type="text">
			</div>
			
			<div class="lname" data-role="fieldcontain">
				<label for="lname"> Owner </label> <input name="lname"
					id="lname" placeholder="Aberathne" value="" type="text">
			</div>
			
			<div class="age" data-role="fieldcontain">
				<label for="age"> Contact No </label> <input name="age" id="age"
					placeholder="071-9545-073" value="" type="number">
			</div>
			
			<div data-role="fieldcontain">
				<label for="select-choice-1" class="select">GramaNiladhari Division</label>
				<select name="select-choice-GNW" id="select-choice-GNW">
					<option id ="gramaNiladhariDivision " value="GramaNiladhari Division 1">GramaNiladhari Division 1</option>
					<option id ="gramaNiladhariDivision " value="GramaNiladhari Division 2">GramaNiladhari Division 2</option>
					<option id ="gramaNiladhariDivision " value="GramaNiladhari Division 3">GramaNiladhari Division 3</option>
					<option id ="gramaNiladhariDivision " value="GramaNiladhari Division 4">GramaNiladhari Division 4</option>
				</select>
			</div>
			
			<div data-role="fieldcontain">
				<label for="textarea">Address:</label>
				<textarea cols="40" rows="8" name="address" id="address"></textarea>
			</div>
			
			<div class="ui-block-a"><button type="submit" data-theme="d">Location in a Map</button></div>
			
			<div data-role="fieldcontain">
	         <label for="name">Race: </label>
	         <input type="text" name="race" id="race" value=""  />
			</div>
			
			<div data-role="fieldcontain">
	         <label for="name">Income Rs:</label>
	         <input type="text" name="income" id="income" value=""  />
			</div>
			
			<input class="buttonClass" type="button" value="Insert Data" onclick="persistData(this.form)">
		</div>
 
 </form>

 <p><em>Press and hold on the text to copy and export. To scroll contents, tap in field and wait for keyboard, then scroll.</em></p>

<!-- insert query results here, text-only -->
 <textarea id="output" rows="15" placeholder="Results displayed here"></textarea> 

 <input type="button" class="buttonClass" style="background-color: #faa;" onclick='dropDb();' value="Delete Database">

<!-- insert query results here as table rows --> 
 


 <input type="button" class="buttonClass" onclick='window.location="http://iphonedevlog.wordpress.com/2014/03/21/cordova-websql-database-with-user-added-data/"' value="View Code on iPhoneDevLog">
</div>

<script>

/* IMPORTANT! for increased security, add form validation (not used on this page). 
Perhaps get it from: http://rickharrison.github.io/validate.js/ */

// set form field input

function persistData (fname,lname,age,gramaNiladhariDivision,address,race,income){
// get form entries
 var form = document.getElementById("userInput"); 
 var fname = form.fname.value;
 var lname = form.lname.value;
 var age = form.age.value;
 var gramaNiladhariDivision = form.gramaNiladhariDivision.value;
 var address = form.address.value;
 var race = form.race.value;
 var income = form.income.value;
 
// set value if input was blank
 if (fname === "undefined") { fname = "" }; 
 if (lname === "undefined") { lname = "" };
 if (age === "undefined") { age = "" };
 if (gramaNiladhariDivision  === "undefined") { gramaNiladhariDivision  = "" };
 if (address === "undefined") { address = "" };
 if (race === "undefined") { race = "" };
 if (income === "undefined") { income = "" };
 
// check form entries on console
 console.log("datafname = " + fname); 
 console.log("datalname = " + lname);
 console.log("dataage = " + age);
 console.log("datagramaNiladhariDivision = " + gramaNiladhariDivision);
 console.log("dataaddress = " + address);
 console.log("datarace = " + race);
 console.log("dataincome = " + income);

// key, value pair into localStorage
 localStorage.setItem('fnameSet', fname); 
 localStorage.setItem('lnameSet', lname); 
 localStorage.setItem('ageSet', age);
 localStorage.setItem('gramaNiladhariDivisionSet', gramaNiladhariDivision);
 localStorage.setItem('addressSet', address);
 localStorage.setItem('raceSet', race);
 localStorage.setItem('incomeSet',income);
 
// set the current time as the id to make it unique id
 var d = new Date();
 var new_id = d.getTime();
 localStorage.setItem('new_idSet', new_id);
// proceed to next function
 startDB(); 
}

function startDB() {
 var db = window.openDatabase("Database", "1.0", "DEMO", 2000000);
 db.transaction(populateDB, errorCB, successCB);
}

// Form the query

function populateDB(tx) {
 var formdata1Get = localStorage.getItem('fnameSet'); // get data from localStorage
 var formdata2Get = localStorage.getItem('lnameSet');
 var formdata3Get = localStorage.getItem('ageSet');
 var formdata4Get = localStorage.getItem('gramaNiladhariDivisionSet');
 var formdata5Get = localStorage.getItem('addressSet');
 var formdata6Get = localStorage.getItem('raceSet');
 var formdata7Get = localStorage.getItem('incomeSet');

 
 var new_idGet = localStorage.getItem('new_idSet');
// if no data has been entered, show note and stop the process
 if (formdata1Get.length < 1 && formdata2Get.length < 1 && formdata3Get.length < 1) { 
 document.getElementById("output").innerHTML = "\nPLEASE ENTER DATA"; return false; 
 }
 tx.executeSql('CREATE TABLE IF NOT EXISTS DEMO (id TEXT NOT NULL, fname TEXT NULL, lname TEXT NULL,  age TEXT NULL, gramaNiladhariDivision TEXT NULL, address TEXT NULL, race TEXT NULL, income TEXT NULL)'); 
 tx.executeSql('INSERT INTO DEMO (id, fname, age, gramaNiladhariDivision,address,race,income) VALUES (\"' + new_idGet + '\"' + ', \"' + formdata1Get + '\",\"' + formdata2Get + '\",\"' + formdata3Get + '\",\"' + formdata4Get + '\",\"' + formdata5Get + '\", \"' + formdata6Get + '\", \"' + formdata7Get + '\")');
 queryDB(tx);
}

// Execute the query, grabbing all the data

function queryDB(tx) {
 tx.executeSql("SELECT * FROM DEMO", [], querySuccess, errorCB);
}

function querySuccess(tx, results) {
 var len = results.rows.length;
 console.log("Returned rows = " + results.rows.length);
// set output, output2 to blank so values are not appended to previous values
 document.getElementById("output").innerHTML = "";
 document.getElementById("output2").innerHTML = "";
// loop through rows as many times as there are row results
 for (var i = 0; i < len; i++) { 
 var rowid = results.rows.item(i).id;
// Display the query results within <textarea id="output"></textarea>
 document.getElementById("output").innerHTML += "\nID = " + results.rows.item(i).id +
 "\nFirst Name = " + results.rows.item(i).fname +
 "\nLast Name = " + results.rows.item(i).lname +
 "\nAge = " + results.rows.item(i).age +
 "\nGrammerNiladhari Division = " + results.rows.item(i).gramaNiladhariDivision +
 "\nAddress = " + results.rows.item(i).address +
 "\nRace = " + results.rows.item(i).race +
 "\nIncome = " + results.rows.item(i).income + "\n";
 

// reset form input fields to blank
 var form = document.getElementById("userInput"); 
 form.fname.value = "";
 form.lname.value = "";
 form.age.value = ""; 
 form.gramaNiladhariDivision.value = "";
 form.address.value = "";
 form.race.value = "";
 form.income.value = "";
}

// Show DB onload (next two functions)

function showDB(tx) {
 var db = window.openDatabase("Database", "1.0", "DEMO", 2000000);
 db.transaction(createDB, errorCB, successCB);
}
function createDB(tx) {
 tx.executeSql("SELECT * FROM DEMO", [], querySuccess, errorCB);
}

// Delete a row in the DB from button

function delRecord(rowid) {
 var db = window.openDatabase("Database", "1.0", "DEMO", 2000000);
 db.transaction(
 function (tx) {
 tx.executeSql("DELETE FROM demo WHERE id = ?", [rowid]);
 }
 ); 
 document.getElementById("output").innerHTML = "";
 document.getElementById("output2").innerHTML = "";
 location.reload(false); // refresh page to show changes
}

// Transaction success callback

function successCB() {
 console.log("_______ Success! _______");
}

// Transaction error callback

function errorCB(err) {
 if (err.code == "0") {
 console.log("0 - UNKNOWN_ERR: The transaction failed for reasons unrelated to the database itself and not covered by any other error code.");
 }
 if (err.code == "1") {
 console.log("1 - DATABASE_ERR: The statement failed for database reasons not covered by any other error code.");
 }
 if (err.code == "2") {
 console.log("2 - VERSION_ERR: The operation failed because the actual database version was not what it should be. For example, a statement found that the actual database version no longer matched the expected version of the Database or DatabaseSync object, or the Database.changeVersion() or DatabaseSync.changeVersion() methods were passed a version that doesn't match the actual database version.");
 }
 if (err.code == "3") {
 console.log("3 - TOO_LARGE_ERR: The statement failed because the data returned from the database was too large. The SQL 'LIMIT' modifier might be useful to reduce the size of the result set.");
 }
 if (err.code == "4") {
 console.log("4 - QUOTA_ERR: The statement failed because there was not enough remaining storage space, or the storage quota was reached and the user declined to give more space to the database.");
 }
 if (err.code == "5") {
 console.log("5 - SYNTAX_ERR: The statement failed because of a syntax error, or the number of arguments did not match the number of ? placeholders in the statement, or the statement tried to use a statement that is not allowed, such as BEGIN, COMMIT, or ROLLBACK, or the statement tried to use a verb that could modify the database but the transaction was read-only.");
 }
 if (err.code == "6") {
 console.log("6 - CONSTRAINT_ERR: An INSERT, UPDATE, or REPLACE statement failed due to a constraint failure. For example, because a row was being inserted and the value given for the primary key column duplicated the value of an existing row.");
 }
 if (err.code == "7") {
 console.log("7 - TIMEOUT_ERR: A lock for the transaction could not be obtained in a reasonable time.");
 }
}


// "drop (delete) database" sequence, next two functions

function dropDb() {
// erase localStorage
 window.localStorage.clear();
// erase form fields
 var form = document.getElementById("userInput"); 
 form.data1.value = "";
 form.data2.value = "";
 form.data3.value = "";
 document.getElementById("output").innerHTML = "";
 document.getElementById("output2").innerHTML = "";
// start the "drop database" sequence
 var db = window.openDatabase("Database", "1.0", "DEMO", 2000000);
 db.transaction(dropDatabase, errorCB, successCB);
}
function dropDatabase(tx) {
 tx.executeSql('DROP TABLE IF EXISTS DEMO');
 console.log("_______ Table Dropped! _______");
}

// Show the DB contents on page load
showDB(); 
</script>
</body>
</html>
<!-- ********************* HMTL5 Storage end *********************** -->